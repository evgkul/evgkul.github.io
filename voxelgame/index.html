<!DOCTYPE html>
<html>

<head>
    <meta charset="utf8">
    <style>
        #logs {
            /*width: 100%;*/
            /*height: 20em;
                overflow: auto;*/
            border: 1px solid red;
            height: 600px;
            overflow: auto;
        }

        #logs hr {
            margin: 0;
        }

        body {
            /*display: flex;*/
        }
    </style>
</head>

<body>
    <div style="display: flex">
        <div>
            <div id="logs"></div>
            <button onclick="fullscreen()">Открыть игру</button>
        </div>
        <canvas id="target" width="800" height="600"></canvas>
    </div>

    <div style="width: 0px; height: 0px; overflow: hidden; position: absolute; left: 0px; top: 0px">
        <!--<canvas id="target" width="1600" height = "900"></canvas>-->
    </div>
    <script>
        /** @type {HTMLCanvasElement} */
        var canvas = document.getElementById('target');
        var isWorker = false;
        window.fullscreen = async function () {
            canvas.requestPointerLock();
            var r = await canvas.requestFullscreen();
            //console.log('FULLSCREEN!',r);
        }
        document.addEventListener("keydown", function (e) {
            console.log('EVENT!', e.type, typeof e.type, e.key);
            e.preventDefault();
            pushEvent({ type: 'keydown', code: e.code });
        });
        document.addEventListener("keyup", function (e) {
            //console.log('EVENT!',e.type, typeof e.type);
            e.preventDefault();
            pushEvent({ type: 'keyup', code: e.code });
        });
        document.addEventListener('keypress', function (e) {
            e.preventDefault();
            pushEvent({
                type: 'keypress',
                key: e.key
            });
        });
        canvas.addEventListener('mousemove', function (e) {
            e.preventDefault();
            pushEvent({
                type: 'mousemove',
                movementX: e.movementX,
                movementY: e.movementY
            });
        });
        canvas.addEventListener('mousedown', function (e) {
            e.preventDefault();
            pushEvent({
                type: 'mousedown',
                button: e.button
            });
        });
        canvas.addEventListener('mouseup', function (e) {
            e.preventDefault();
            pushEvent({
                type: 'mouseup',
                button: e.button
            });
        });
        var logs = document.getElementById('logs');
        var logstr = [];
        window.print_log = function (str) {
            let spl = str.split('\n');
            //console.log('RUST: ',str);
            for (var i = 0; i < spl.length; i++) {
                let span = document.createElement('span');
                let part = spl[i];
                span.innerText = part;
                logs.appendChild(span);

                if (i > 0) {
                    console.log('RUST: ', logstr.join(''));
                    logstr = [];
                    let hr = document.createElement('hr');
                    logs.appendChild(hr);
                }
                logstr.push(part);
            }

        }
        if (isWorker) {
            var transferred = canvas.transferControlToOffscreen();
            var offscr = new OffscreenCanvas(transferred.width, transferred.height);

            var cont = offscr.getContext("webgl2");
            //var bitmap_target = transferred.getContext("bitmaprenderer");
            var events = [];
            var worker = new Worker("worker.js");

            window.getSize = function () {
                return {
                    w: Math.ceil(canvas.width),
                    h: Math.ceil(canvas.height)
                };
            }
            function pushEvent(e) {
                //events.push(e);
                worker.postMessage({
                    type: 'event',
                    event: e
                });
            }
            window.pushEvent = pushEvent;


            window.get_context = function () {
                return cont;
            }
            window.render_loop = function (f) {
                function l(delta) {
                    f(events);
                    var bitmap = offscr.transferToImageBitmap();
                    bitmap_target.transferFromImageBitmap(bitmap);
                    events = [];
                    requestAnimationFrame(l);
                }
                requestAnimationFrame(l);
            }
            window.get_asset = function (store, path) {
                let res = fetch("assets/" + path).then(response => response.arrayBuffer());
                return res;
            }

            worker.postMessage({ canvas: transferred }, [transferred]);
        } else {
            let events = []
            let cont = canvas.getContext('webgl2');
            window.getSize = function () {
                return {
                    w: Math.ceil(canvas.width),
                    h: Math.ceil(canvas.height)
                };
            }
            window.pushEvent = function(e){
                events.push(e);
            }
            window.get_context = function () {
                return cont;
            }
            window.render_loop = function (f) {
                function l(delta) {
                    f(events);
                    events = [];
                    requestAnimationFrame(l);
                }
                requestAnimationFrame(l);
            }
            window.get_asset = function (store, path) {
                let res = fetch("assets/" + path).then(response => response.arrayBuffer());
                return res;
            }
            let scr = document.createElement('script');
            scr.src = "rust_voxelgame.js";
            document.body.appendChild(scr);
        }

    </script>
    <!--<script src="rust_voxelgame.js"></script>-->
</body>

</html>